replicaCount: 1

image:
  repository: docker.elastic.co/logstash/logstash
  tag: "8.10.0"
  pullPolicy: IfNotPresent

service:
  type: ClusterIP
  port: 9600
  name: logstash

# Конфигурация пайплайна Logstash
pipeline:
  input: |
    kafka {
      bootstrap_servers => "kafka.kafka:9092"
      topics => ["logs"]
      codec => "json"
      group_id => "logstash"
      consumer_threads => 2
    }

  filter: |
    # Добавляем информацию о Kubernetes
    if [kubernetes] {
      mutate {
        add_field => {
          "namespace" => "%{[kubernetes][namespace]}"
          "pod" => "%{[kubernetes][pod_name]}"
          "container" => "%{[kubernetes][container_name]}"
        }
      }
    }
    
    # Парсим trace и span ID для связывания с Zipkin
    if [traceId] {
      mutate {
        add_field => {
          "[@metadata][traceId]" => "%{traceId}"
          "[@metadata][spanId]" => "%{spanId}"
        }
      }
    }
    
    # Парсим timestamp
    date {
      match => [ "timestamp", "ISO8601" ]
    }
    
    # Удаляем поля которые не нужны
    mutate {
      remove_field => [ "@version", "host" ]
    }

  output: |
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "logs-%{+YYYY.MM.dd}"
      document_id => "%{[@metadata][fingerprint]}"
    }
    
    # Дублируем в stdout для отладки
    stdout {
      codec => rubydebug
    }

# Конфигурация Logstash
config:
  pipeline:
    workers: 2
    batch:
      size: 125
      delay: 50

resources:
  requests:
    memory: "512Mi"
    cpu: "300m"
  limits:
    memory: "1Gi"
    cpu: "600m"